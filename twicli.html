<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=300">
<title>twicli</title>
<style>
body {background-color: transparent; margin: 1px;}
#tw, #tw_p { font-size: small; }
#tw div div, #tw_p div div { padding: 2px; }
img { border: 0; }
.status { text-decoration: none; color: black; cursor: pointer; }
.date { color: #999; font-size: x-small; }
.fromme { background-color: #cfc; }
.tome { background-color: #ccf; }
#loading {opacity: 0.5; position: absolute; left: 50px; top: 2px; width: 220px; height: 19; }
#fst { position: absolute; left: 56px; top: 0px; width: 208px; }
#rst { position: absolute; left: 264px; top: 6px; text-decoration: none; }
hr { margin: 0; padding: 0; }
form { margin: 5px; }
</style>
</head>
<body>
<iframe style="display:none;" name="tx"></iframe>
<a href="http://twitter.com/home" target="twitter"><b><small>Twitter</small></b></a>
<!--発言フォーム-->
<form name="frm" action="http://twitter.com/statuses/update.xml" method="POST" onSubmit="if (this.status.value == '') { reload(0); return false; } this.status.select(); setTimeout('document.frm.reset()',10); reload(3000)" target="tx">
<small><input id="fst" type="text" name="status"><input type="hidden" name="source" value="twicli">
<a id="rst" href="javascript:document.frm.reset()"><img src="clr.png"></a>
</small><img id="loading" src="loading.gif"></form>
<!--favフォーム-->
<form name="favf" action="" method="POST" target="tx"></form>

<div id="tw"><hr></div>

<script>
var nr_limit = 50;				// 表示する更新回数の上限

var seq = (new Date).getTime();
var since_id = false;
var myname = false;
var old_script_ele = false;
// ローディング表示ON、twit更新
function reload(to) {
	document.getElementById("loading").style.display = "block";
	setTimeout("update()", to);
}
// 最新twitを取得
function update(page) {
	if (old_script_ele)
		old_script_ele.parentNode.removeChild(old_script_ele);
	var s = document.createElement('script');
	s.src = 'http://twitter.com/statuses/friends_timeline?seq='+(seq++)+'&callback=twShow' +
		(page ? '&page='+page : '') + (!page && since_id ? '&since_id='+since_id : '');
	document.body.appendChild(s);
	old_script_ele = s;
}
// twitのHTML表現を生成
function q(str) { return "'"+str+"'" }
function d2(dig) { return (dig>9?"":"0") + dig }
function makeHTML(tw) {
	var d = new Date(tw.created_at);
	d = d.getDate() + "日 " + d.getHours() + ":" + d2(d.getMinutes()) + ":" + d2(d.getSeconds());
	return (tw.user.url ? '<a target="twitter" href="'+tw.user.url+'">' : '') +
		'<img border="0" align="left" width="24" height="24" alt="'+ tw.user.name +
			'" src="' + tw.user.profile_image_url + '">' + (tw.user.url ? '</a>' : '') +
		'<img align="right" src="http://assets3.twitter.com/images/icon_star_'+(tw.favorited?'full':'empty')+'.gif" '+
		'onClick="fav(this,' + tw.id + ')">' + 
		'<a target="twitter" href="http://twitter.com/'+tw.user.screen_name+'">' +
		tw.user.screen_name + (tw.user.name!=tw.user.screen_name?'('+tw.user.name+')':'') + '</a> ' +
		'<span onClick="if (\'\' == window.getSelection().toString()) { document.frm.status.value = '+
			q("@"+tw.user.screen_name+" ")+'; document.frm.status.focus() }" class="status">' +
			tw.text.replace(/(https?:\/\/[^ ]*)/g, " <a onClick=\"event.stopPropagation();\" target=\"_blank\" href=\"$1\">$1</a>")
				.replace(/@([0-9A-Za-z_\-]+)/g, "<a onClick=\"event.stopPropagation();\" target=\"twitter\" href=\"http://twitter.com/$1\">@$1</a>") +
		'</span> <span class="date">' + d + '</span><br clear="left">';
}
// favoriteの追加(f=true)/削除(f=false)
function fav(img, id) {
	var f = img.src.match('empty');
	document.favf.action = 'http://twitter.com/favourings/' + (f ? 'create' : 'destroy') + '/' + id + '.xml';
	document.favf.submit();
	img.src = 'http://assets3.twitter.com/images/icon_star_' + (f ? 'full' : 'empty') + '.gif';
}
// 自分の最新の発言を受信
function twUser(tw) {
	myname = tw[0].user.screen_name;
}
// 受信twitを表示
function twShow(tw) {
	var len = tw.length;
	if (len == 0) return;
	var twNode = document.getElementById('tw');
	var pNode = document.createElement('div');
	var dummy = pNode.appendChild(document.createElement('div'));
	for (i = len-1; i >= 0; i--) {
		if (since_id && since_id >= tw[i].id)
			continue;
		var s = document.createElement('div');
		if (tw[i].user.profile_image_url) {
			s.innerHTML = makeHTML(tw[i]);
			if (tw[i].text.match('@'+myname+' '))
				s.className = "tome";
			if (tw[i].user.screen_name == myname)
				s.className = "fromme";
			pNode.insertBefore(s, pNode.childNodes[0]);
			pNode.insertBefore(document.createElement('hr'), s);
		}
	}
	pNode.removeChild(dummy);
	twNode.insertBefore(pNode, twNode.childNodes[0]);
	var maxH = pNode.clientHeight;
	pNode.style.overflow = "hidden";
	animate(pNode, maxH, 0);
	while (twNode.childNodes.length > nr_limit)
		twNode.removeChild(twNode.childNodes[nr_limit]);
	document.getElementById('loading').style.display='none';
	if (failover_timeout) clearTimeout(failover_timeout);
	failover_timeout = false;
	since_id = tw[0].id;
}
// 新規twitの出現アニメーション処理
function animate(elem, max, cur) {
	elem.style.maxHeight = cur;
	if (cur == max)
		return elem.style.maxHeight = 'none';
	cur += Math.ceil(Math.min(Math.min(cur/3, (max-cur)/2), 30))+1;
	if (cur > max) cur = max;
	setTimeout(function(){ animate(elem, max, cur) }, 50);
}
// 初回アップデート
setTimeout("update();", 0);
// ログインしていなかったときなどに15秒で本家にリダイレクト
var failover_timeout = setTimeout("location.href='http://twitter.com/home'", 15*1000);
setInterval("update()", 30*1000);

// ホイールの回転でスクロール (スクロール不可のウィンドウ・フレーム内で有効)
function wheel(event) {
	var delta = 0;
	if (!event) event = window.event;
	if (event.wheelDelta) {
		delta = event.wheelDelta/10;
	} else if (event.detail)
		delta = -event.detail;
	if (navigator.userAgent.indexOf("Firefox") != -1)
		delta *= 10;
	if (delta)
		scrollBy(0, -delta);
	if (event.preventDefault)
		event.preventDefault();
	event.returnValue = false;
}
if (window.addEventListener) window.addEventListener('DOMMouseScroll', wheel, false);
window.onmousewheel = document.onmousewheel = wheel;
</script>
<script src="http://twitter.com/statuses/user_timeline.json?count=1&callback=twUser"></script>
</body>
</html>